services:
  # Redis Cache Service (Internal Only)
  redis:
    image: redis:7-alpine
    container_name: chainreactions-redis
    # Remove external port exposure for security - only accessible within Docker network
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-your_strong_redis_password_here}
    networks:
      - chainreactions-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-your_strong_redis_password_here}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Core Microservices
  entity-relations:
    build:
      context: .
      dockerfile: services/entity-relations/Dockerfile
    container_name: chainreactions-entity-relations
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - BRIGHT_DATA_API_KEY=${BRIGHT_DATA_API_KEY}
      - BRIGHT_DATA_SERP_ZONE=${BRIGHT_DATA_SERP_ZONE}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chainreactions-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/api/health", "||", "exit", "1"]
      interval: 300s
      timeout: 15s
      retries: 2
      start_period: 60s

  entity-search:
    build:
      context: .
      dockerfile: services/entity-search/Dockerfile
    container_name: chainreactions-entity-search
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - LINKUP_API_KEY=${LINKUP_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - LINKUP_BASE_URL=${LINKUP_BASE_URL:-https://api.linkup.so/v1}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chainreactions-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/api/health", "||", "exit", "1"]
      interval: 180s
      timeout: 30s
      retries: 4
      start_period: 120s

  dataset-matching:
    build:
      context: .
      dockerfile: services/dataset-matching/Dockerfile
    container_name: chainreactions-dataset-matching
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=production
      - PORT=3004
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - DEFAULT_MIN_CONFIDENCE=${DEFAULT_MIN_CONFIDENCE:-0.6}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chainreactions-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3004/api/health", "||", "exit", "1"]
      interval: 180s
      timeout: 30s
      retries: 4
      start_period: 120s

  data-management:
    build:
      context: .
      dockerfile: services/data-management/Dockerfile
    container_name: chainreactions-data-management
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=production
      - PORT=3005
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - UPLOAD_PATH=${UPLOAD_PATH:-./uploads}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-50MB}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - uploads-data:/app/uploads
    restart: unless-stopped
    networks:
      - chainreactions-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3005/api/health", "||", "exit", "1"]
      interval: 300s
      timeout: 15s
      retries: 2
      start_period: 60s

  dataset-search:
    build:
      context: .
      dockerfile: services/dataset-search/Dockerfile
    container_name: chainreactions-dataset-search
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=production
      - PORT=3006
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - LINKUP_API_KEY=${LINKUP_API_KEY}
      - LINKUP_API_KEY_2=${LINKUP_API_KEY_2}
      - LINKUP_BASE_URL=${LINKUP_BASE_URL:-https://api.linkup.so/v1}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chainreactions-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3006/api/health", "||", "exit", "1"]
      interval: 180s
      timeout: 30s
      retries: 4
      start_period: 120s

  user-management:
    build:
      context: .
      dockerfile: services/user-management/Dockerfile
    container_name: chainreactions-user-management
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=production
      - PORT=3007
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3001}
      - JWT_SECRET=${JWT_SECRET}
      - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET}
      - BCRYPT_ROUNDS=${BCRYPT_ROUNDS:-12}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-1h}
      - REFRESH_TOKEN_EXPIRES_IN=${REFRESH_TOKEN_EXPIRES_IN:-7d}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}
      - AUTH_RATE_LIMIT_WINDOW_MS=${AUTH_RATE_LIMIT_WINDOW_MS:-300000}
      - AUTH_RATE_LIMIT_MAX_REQUESTS=${AUTH_RATE_LIMIT_MAX_REQUESTS:-10}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3001,http://localhost:5173}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chainreactions-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3007/api/health", "||", "exit", "1"]
      interval: 180s
      timeout: 30s
      retries: 4
      start_period: 120s

# Networks
networks:
  chainreactions-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# Named Volumes
volumes:
  redis-data:
    driver: local
    name: chainreactions-redis-data
  uploads-data:
    driver: local
    name: chainreactions-uploads